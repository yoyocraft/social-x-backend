<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.youyi.domain.task.repository.mapper.SysTaskMapper">

    <resultMap id="SysTaskResultMap" type="com.youyi.domain.task.repository.po.SysTaskPO">
        <id column="id" property="id"/>
        <result property="gmtCreate" column="gmt_create"/>
        <result property="gmtModified" column="gmt_modified"/>
        <result property="extraData" column="extra_data"/>
        <result property="deletedAt" column="deleted_at"/>
        <result property="taskId" column="task_id"/>
        <result property="taskType" column="task_type"/>
        <result property="taskStatus" column="task_status"/>
    </resultMap>

    <sql id="result_cols">
        id, gmt_create, gmt_modified, deleted_at, extra_data, task_id, task_type, task_status
    </sql>
    <insert id="insert">
        INSERT INTO sys_task(extra_data, task_id, task_type, task_status)
        VALUES (#{extraData}, #{taskId}, #{taskType}, #{taskStatus})
    </insert>
    <insert id="insertBatch">
        INSERT INTO sys_task(extra_data, task_id, task_type, task_status)
        VALUES
        <foreach collection="poList" item="item" index="index" separator=",">
            (#{item.extraData}, #{item.taskId}, #{item.taskType}, #{item.taskStatus})
        </foreach>
    </insert>
    <update id="updateStatus">
        UPDATE sys_task
        SET task_status = #{taskStatus}
        WHERE task_id IN (
            <foreach collection="taskIds" item="item" separator=",">
                #{item}
            </foreach>
        )
    </update>

    <select id="queryByTypeAndStatusWithCursor" resultType="com.youyi.domain.task.repository.po.SysTaskPO">
        SELECT
        <include refid="result_cols"/>
        FROM sys_task
        WHERE task_type = #{taskType}
        AND task_status IN (
            <foreach collection="taskStatus" item="item" separator=",">
                #{item}
            </foreach>
        )
        AND deleted_at = 0
        AND id <![CDATA[ > ]]> #{cursor}
        ORDER BY gmt_modified DESC, id DESC
        LIMIT #{size}
    </select>
    <select id="queryToCompensationTasksWithCursor" resultType="com.youyi.domain.task.repository.po.SysTaskPO">
        SELECT
        <include refid="result_cols"/>
        FROM sys_task
        WHERE task_type = #{taskType}
        AND gmt_modified <![CDATA[ < ]]> NOW() - INTERVAL 1 DAY
        AND task_status IN (
            <foreach collection="taskStatus" item="item" separator=",">
                #{item}
            </foreach>
        )
        AND deleted_at = 0
        AND id <![CDATA[ > ]]> #{cursor}
        ORDER BY gmt_modified DESC, id DESC
        LIMIT #{size}
    </select>




</mapper>

