@startuml

autonumber

actor user
participant "平台" as front
participant "Server" as backend
database "Redis" as redis
database "DB" as db
participant "Email" as email


group 设置密码
==发送验证码==
    user -> front: 输入邮箱
    front -> backend: 获取验证码
    backend -> backend: 校验邮箱合法性
    alt 校验错误
        backend --> front: 验证失败
    else 校验通过
        backend -> backend: 生成验证码
        backend -> redis: 存储验证码
        backend -> email: 发送验证码
    end

==校验验证码==
    user -> front: 输入验证码，验证
    backend -> backend: 校验验证码
    alt 校验错误
        backend --> front: 验证失败
    else 校验通过
        backend -> front: 验证成功
        backend -> backend: 生成临时 token
        backend -> redis: 存储临时 token
        backend -> backend: 删除验证码
        backend --> front: 临时 token
        front -> front: 跳转至设置密码Modal
    end

==设置密码==
   user -> front: 输入新密码，确认新密码
   front -> backend: 提交，携带临时 token
   backend -> backend: 校验临时 token
   alt 校验错误
       backend --> front: 验证失败
   else 校验通过
       backend -> backend: 删除临时 token
       backend --> front: 验证成功
   end
   backend -> backend: 校验新密码和确认新密码
   alt 校验错误
       backend --> front: 验证失败
   else 校验通过
       backend -> backend: 加盐加密
       backend -> db: 查询密码凭证信息
       alt 不存在
           backend -> db: 创建密码凭证信息
       else 存在
           backend -> db: 更新密码凭证信息
       end
       backend -> front: 设置成功
   end
end
@enduml